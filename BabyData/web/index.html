<!DOCTYPE html>

<html ng-app="babyApp">
<head>
	<title>Baby Test</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="media/base.css"/>
	<link rel="stylesheet" href="media/web.css"/>
	<script src="media/babyData.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular.min.js"></script>
	
	
	<script>

	//After load do all the cool stuff.
	document.addEventListener("DOMContentLoaded", function(){
		window.bD = new babyData("theChart");
		bD.updateChart([
			bD.dataset("diaper",[1,2,3]),
			bD.dataset("feeding",[2,1,4]),
			bD.dataset("sleep",[12,11,14]),
			] ,{
				height:document.getElementById("theChart").height,
				width:document.getElementById("theChart").width,
				graph_type:"bar",
				background:false,
				label_axis_x:"Number",
				label_axis_y:"Days Ago"
			});
				
	}, false);


	</script>
	<script>
	angular.module('babyApp', [])
		.controller('babyController', function($scope, $http) {
			var babyController = this;
			this.baby={};
			this.User={};
			this.glance = {};
			this.search = {};
			this.chartform = {};
			
			this.ServiceUrl="../Service.ashx";

			//called at init
			this.init =function(bd){
				
			//	console.log(bD.query);
				this.search = this.readQueryString();

				this.getBaby(this.search.baby);
				
			};

			//gets data for the baby.
			this.getEventData = function(babyId){
				$http.get(this.ServiceUrl+"?type=babyevents&id="+babyId).then(

					function(response){
						var events = response.data.events;
				
						for(var i =0; i < events.length; i++){
							babyController.addEvent(events[i]);
						}
					},
					function(response){
						console.log("error @ load events", response);

					}
					
				);
					
				//calculate time_agoago
			};

			//adds data to the UI
			this.addEvent = function(event){

				if(!babyController.baby.events){
					babyController.baby.events = [];
				}
				if(babyController.baby.events.indexOf(event)<0){
					babyController.baby.events.push(event);
					if(!babyController.glance[event.type] ||
						babyController.glance[event.type].time < event.time){
						babyController.glance[event.type] = event;
					}
					
				}

			};

			//adds data to the db
			this.reportEvent=function(type, subtype, details){

				$http.post(this.ServiceUrl+
					"?type=babyevents"+
					"&id="+babyController.baby.id+
					"&eventtype="+ type +
					"&subtype="+ subtype||"" +
					"&details="+ details||"").then(
						function(response){
							
							babyController.addEvent(response.data.events[0]);
						},
						function(response){
							console.log("error @ load user", response);
							babyController.addEvent("ERROR",
							response.data.server_error.type+": " +
								response.data.server_error.message);
						}
					);
			}
			//used to do tabbed interface.
			this.showTab=function(ele_id){
				var tgt = document.getElementById(ele_id);
				if(tgt){
					var tabs = document.getElementsByClassName("tab");
					for(var i = 0; i < tabs.length;i++){
						tabs[i].classList.remove("show");
						tabs[i].classList.add("hide");
					}
					tgt.classList.add("show");
					tgt.classList.remove("hide");
				}
			};
			//Gets user data
			this.getUserData=function(username){
				$http.get(this.ServiceUrl+"?type=user&id="+babyId).then(
					function(response){
						console.log("success", response)
					},
					function(response){
						console.log("error @ load user", response);

					}
				);

			};

			//get requested baby
			this.getBaby=function(babyId){
				$http.get(this.ServiceUrl+"?type=baby&id="+babyId).then(
					function (response){
						babyController.baby= response.data;
						babyController.getEventData(babyController.baby.id);

					},
					function (response){
						console.log("error @ baby load", response);
						babyController.baby= {
							"name":"ERROR LOADING BABY",
							"events":[]
						};
						//show on the baby list.
						babyController.addEvent("ERROR",
							response.data.server_error.type+": " +
								response.data.server_error.message);
						document.getElementById("baby-header").classList.add("error");
						
					}
				);
			};

			//update teh chart
			this.updateChart=function(){
				if(!this.chartform){
					console.log("no data to chart");
					return;
				}

				console.log("updaing charts with data", this.chartform);
				//TODO get data from the baby
				
				var now = new Date();
				var ms_day = 1000*3600*24;
				var days = this.chartform.days||1;
				var ms = ms_day +days;
				var data = {};
				var labels =[];

				for(var  i = days-1; i >= 0;i--){
					labels.push(i)//TODOd dates
				}

				
				for(var key in this.glance){
					if(this.chartform[key]){
						var info = [];
						for(var i = 0; i < days; i++){
							info.push(0);
						}
						data[key] = info;
					}
				}
				console.log(data);

				var evt,ago,tgt;
				for(var i = 0; i < this.baby.events.length; i++){
					evt= this.baby.events[i];
					if(evt.type in data){
						ago = Math.abs(Date.parse(evt.time) - now);
						//are we in teh windw
						
						if(ago){
							tgt = Math.floor(days-(ago+1)/ms_day);
							data[evt.type][tgt]++;
						}
					}
				}

				var dataset =[];
				for(var key in data){
					dataset.push({
						"color": bD.getColorFromString(key),
						"name":key,
						"items":data[key],
						"labels":labels});
				}	
				console.log("datset",dataset);

			

				
				bD.updateChart(dataset,
					{
						height:document.getElementById("chart").height,
						width:document.getElementById("chart").width,
						graph_type:days<7?"bar":"line",
						background:false,
						label_axis_x:"Number",
						label_axis_y:"Days Ago",
						title:"Events by type for Last "+days + " days"
					}
				);
			};

			//turn time stamp into a time ago by major type
			this.getAgo=function(timestamp){
				var ts = Math.abs(Date.parse(timestamp) - new Date());
			
				if(ts){
					if(ts <1000){
						ts ="now"
					}
					else if(ts < 60000){ //1 minute
						ts = Math.round(ts/1000) +" seconds ago";

					}
					else if(ts < 3600000){ //1 hour
						ts = Math.round(ts/60000) +" minutes ago";

					}
					else if(ts < 86400000){ //1 day
						ts = Math.round(ts/3600000) +" hours ago";

					}
					else{
						ts = Math.round(ts/86400000) +" days ago";
					}
				}
				return ts;
			};

			//twhat it says
			this.readQueryString = function(){
				var search = {};
				var query = unescape(window.location.search.substring(1)).split("&");
				for(var i = 0 ; i < query.length;i++){

					var eq= query[i].indexOf('=');
					search[query[i].substring(0,eq)] = query[i].substring(eq+1);
				}
				return search;
			}


			this.init();
		});


	</script>

</head>
<body ng-controller="babyController as bC" >
	<header id="baby-header">
		<div id="user">
			
		</div>
		<h1>{{bC.baby.name}}</h1>
		<nav id="action-bar">
			<button class="diaper" ng-click="bC.reportEvent('diaper','poo')">DIAPER<br/>Poo </button>
			<button class="diaper" ng-click="bC.reportEvent('diaper','pee')">DIAPER<br/>Pee</button>
			<button class="feeding" ng-click="bC.reportEvent('feeding','breast')">FEEDING<br/>breast</button>
			<button class="feeding" ng-click="bC.reportEvent('feeding','breast')">FEEDING<br/>bottle</button>
			<button class="sleep" ng-click="bC.reportEvent('sleep','down')">SLEEP <br/> Down</button>
			<button class="sleep" ng-click="bC.reportEvent('sleep','up')">SLEEP <br/> up</button>
		</nav>
		<nav class="tab-nav">
			<a ng-click="bC.showTab('glance')">glance</a>
			<a ng-click="bC.showTab('timeline')">Timeline</a>
			<a ng-click="bC.showTab('chart')">Chart</a>
		</nav>
	</header>
	
	<article>
		
		<div id="timeline" class="tab hide">
			<h2> Event Timeline</h2>

			<div id="events-list"  ng-repeat="event in bC.baby.events| orderBy:'-time'">
				<div class="event {{event.type.toLowerCase()}}" id ="event-{{event.id}}">
					<div class="chunk time" timestamp="{{event.time}}">
						<p>{{bC.getAgo(event.time)}}</p>
					</div>
					<div class="chunk type">
						<h3>{{event.type.toUpperCase()}}</h3>
						<p>{{event.subtype}}</p>
					</div>
					<div class="chunk user">
						<p><a href="#{{event.user}}">@{{event.user}}</a></p>
						</div>
					<div class="chunk details">
						<p>{{event.details}}</p>
						
					</div>
				</div>	
			</div>

		</div>
		<div id="chart"  class="tab hide">
			<h2>Chart</h2>
			
			<form novalidate>
				<p>Include:</p>
				<div id="filters" ng-repeat="event in bC.glance">
					<label for="{{event.type}}">{{event.type.toUpperCase()}}</label>
					<input name="{{event.type}}" type="checkbox" 
						checked="true" 
						ng-model="bC.chartform[event.type]"><br/>

				</div>
				<label for="days">Show Days</label>
				<input name="days" type="range" min="1" max="30" value="7" ng-model="bC.chartform.days">
				<span>{{bC.chartform.days}}</span><br/>

			
				<label for="submit">&nbsp;</label>
				<input name="submit" type="submit" ng-click="bC.updateChart(bC.chartdata)"><br/>
				
			</form>
			<canvas id="theChart" width="640" height="480"></canvas>
		</div>
			

		<div id="glance" class="tab show">
			<h2>At a Glance</h2>

			<div id="glance-list" ng-repeat="event in bC.glance">
				<div class="event {{event.type.toLowerCase()}}" id ="event-{{event.id}}">
					<div class="chunk time" timestamp="{{event.time}}">
						<p>{{bC.getAgo(event.time);}}</p>
					</div>
					<div class="chunk type">
						<h3>{{event.type.toUpperCase()}}: {{event.subtype}} </h3>
					</div>
					<div class="chunk user">
						<p><a href="#{{event.user}}">@{{event.user}}</a></p>
						</div>
					<div class="chunk details">
						<p>{{event.details}}</p>
						
					</div>
				</div>
			</div>
		</div>
	</article>
	<footer>
	this is wasted space.
	</footer>
</body>
</html>
