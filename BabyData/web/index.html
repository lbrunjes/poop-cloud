<!DOCTYPE html>

<html>
<head>
	<title>Baby Test</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="media/base.css"/>
	<link rel="stylesheet" href="media/web.css"/>

	<script>
	var babyData = function(id){

		this.context = null;
		//setup
		this.init = function(id){
			var ele = document.getElementById(id);
			ele.width = document.getElementById("chart").width||640;
			ele.height  = document.height  -256|| 480 ;
			this.context = ele.getContext("2d");
		}
		//gets a color for css use from a string
		this.getColorFromString = function(input,type){
			var colors =[0,0,0];
			if(type == "rgba"){
				colors.push(0);
			}
			for(var i = 0; i < input.length;i++){
				var idx = i % colors.length;
				var bits = input.charCodeAt(i);
				
					colors[idx] += Math.min(255,colors[idx] + bits);

			}
			var d = input.length /colors.length;

			for(var i = 0; i <colors.length;i++){
				colors[i] = Math.round(colors[i]/d);
			};

			var outval = "";
			switch(type){
				case "rgba":
				var a= colors.pop();
				outval= "rgba(" + colors.join(",") +","+ 
					Math.round(colors[2]/255)+")";
				break;
			case "rgb":
				outval= "rgb(" + colors.join(",") +")";
				break;
			case "hsl":
				//this is less than perfect...
				outval = "hsl(" + Math.round(colors[0]/255*360) + ","+
					 Math.round(colors[1]/255 *100)+"%,"+
					 Math.round(colors[2]/255 *100)+"%)";
				break;
			case "hex":
			default:
				outval=  "#"+ colors[0].toString(16)
					+ colors[1].toString(16)
					+ colors[2].toString(16);
				break;
			}
				return outval;
		};
		this.dataset =function(name, items){
			var ids  =[];
			for(var idx in items){
				ids.push(idx);
			}
			return{
				"color":this.getColorFromString(name), 
				"items":items,
				"labels":ids, 
				"name":name};
		}

	
		this.updateChart =function(data, options){
			var context = this.context;
			console.log("ceating chart for", data, options);
			var opts = {
				font:"16px Ubutunu, Arial, sans-serif",
				font_size:14,

				labels:true,
				label_color:"#fff",
				label_axis_x:"x axis",
				label_axis_y:"y axis",
				title:"title",
			

				lines :true,
				line_color:"rgba(255,255,255,0.5)",
				line_labels:true,
				line_number:10,
				line_round_at:10000,
				range_multiplier: 1.5,
				line_at_zero:true, //TODO
				line_weight:2,

				key:true,

				background:true,
				background_color:"#000",

				graph_type:"bar",
				graph_highlight:true,
				graph_highlight_r:3,
				graph_highlight_color:"rgba(255,255,255,0.5)",

				width:this.context.width,
				height:this.context.height,


				

			};

			//update our options
			if(options){
				for(item in opts){
					if(options[item]){
						opts[item] =options[item];
					}

				}
			}
			console.log("opts",opts)
			//setup the context.
			context.save();

			context.font =opts.font;
			context.width = opts.width;
			context.height = opts.height;

			//invistigate the data.
			var range = 0;
			var range_graph = 0;;
			var min =  999999;
			var max = -999999;
			var points = 0;
			var point_src = 0;
			for(var i  =0; i < data.length; i++){
				if(data[i].items.length> points){
					points = data[i].items.length;
					point_src = i;
				}
				for(var j  =0; j < data[i].items.length; j++){
					max = Math.max(data[i].items[j], max);
					min = Math.min(data[i].items[j], min);
				}
			}

			range = Math.max(max - min, 0.1) ;
			range_graph = range *opts.range_multiplier;

			console.log("range", range, "min", min, "max", max, "points", points);
			
			//is there any data
			if(points==0){
				console.log("no data => Exiting")
				context.fillStyle = opts.label_color;
				context.fillText("NO DATA",context.width/2, context.height/2);
				context.restore();
				return;
			}


			

			//background
			if(opts.background){
				context.fillStyle = opts.background_color;
				context.fillRect(0,0, opts.width, opts.height);
			}
			else{
				context.clearRect(0,0, opts.width, opts.height);	
			}

			//calculate the grid.
			var left_pad = Math.max(max.toString().length +2)*opts.font_size;
			var bottom_pad = opts.font_size * 5;
			var interior_h = opts.height - bottom_pad;
			var interior_w = opts.width - left_pad;

			var y_step_inc = Math.round(
				(range / opts.line_number)* opts.line_round_at)/opts.line_round_at;
			var y_step = Math.round(interior_h/(range_graph/y_step_inc));

			var x_step = Math.floor(interior_w/(points -1));

			if( opts.graph_type == "bar"){
				x_step = Math.floor((opts.width - left_pad)/(points));
			}
		
			
			console.log("left_pad", left_pad, "bottom_pad", bottom_pad, "x_step",x_step, "y_step", y_step,"y_step_inc", y_step_inc);
			

			context.save();
			context.translate(left_pad,0);

			//add lines
			if(opts.lines){
				
				//horizontal
				context.textAlign = "right";

				context.save();
				context.translate(0, interior_h);

				for(var y = 0; y < Math.ceil(opts.line_number * opts.range_multiplier); y++){
					context.fillStyle = opts.line_color;

					context.translate(0, -y_step );
					context.fillRect(0, 0,interior_w, 1);
					console.log(y);
				
					if(opts.line_labels){
						context.fillStyle = opts.label_color;
						context.fillText(Math.round(y *y_step_inc* opts.line_round_at)/opts.line_round_at ,
							opts.font_size/-2, 0 );
					}

				}
				context.restore();

				//vertical
				context.textAlign = "center";

				for(var x = 0; x < points; x++){
					context.fillStyle = opts.line_color;

					context.fillRect(x_step *x, 0 ,
						1,opts.height - bottom_pad);
				
					if(opts.line_labels){
						context.fillStyle = opts.label_color;
						context.fillText(data[point_src].labels[x],
							x_step *x , 
							opts.height - bottom_pad +opts.font_size *1.5);
				
					}

				}
				
			}

			//draw key

			if(opts.key){
				context.textAlign = "left";
				context.save()
				context.translate(0 , y_step/3*2);
				for(var i = 0 ; i <data.length;i++){
					context.fillStyle = data[i].color;
					context.fillText( " █ "+data[i].name, 0,0);
					var next = Math.ceil(context.measureText(" █ "+data[i].name).width);
					console.log(next);
					context.translate(next, 0);

				}
				context.restore();

			}

			


			//draw lines?
			context.save();
			context.translate(0,opts.height - bottom_pad);
			var zero =  (range * (opts.range_multiplier -1))/2;

			var tgt_scale=  (opts.height - bottom_pad)/range_graph;
			context.scale(1,-1 * tgt_scale);
			context.translate(0, min);			

			for(var d = 0; d < data.length; d++){
				context.fillStyle = data[d].color;
				context.strokeStyle = data[d].color;
				context.beginPath();
				var barWidth = x_step/points;


				//start line at the right place
				context.moveTo(0,data[d].items[0] -zero );

				for(var i = 0; i < data[d].items.length; i++){

					/*if(opts.graph_highlight){
						context.arc(X,Y,opts.graph_highlight_r,0,Math.PI/2);
					}*/

					console.log(opts.graph_type,data[d].items[i],
						data[d].items[i] -min
						);
					switch(opts.graph_type){
						
						case "line":
							context.lineTo(i*x_step + d, 
								data[d].items[i] - min);
						break;
						case "bar":
						default:
							context.fillRect( i*x_step + d* barWidth, -zero, barWidth, data[d].items[i] );
					
						break;
					}
				}
				context.lineWidth = opts.line_weight/tgt_scale;
				context.stroke();
			}
			context.restore();


			//hide padding
			context.restore();

			//add axis lavels.
			if(opts.labels){
				context.textAlign = "center";

				context.fillStyle = opts.label_color;

				context.save();
				context.textAlign = "right";
				context.translate(opts.font_size, opts.height -opts.font_size *3);
				context.rotate(Math.PI/2);
				context.fillText(opts.label_axis_x,0,0);
				context.restore();

				context.textAlign = "center";
				context.fillText(opts.label_axis_y,
					opts.width/2 + left_pad/2, opts.height- opts.font_size/2);

				context.fillText(opts.title,
					opts.width/2+ left_pad/2,  opts.font_size*2);

			}






			context.restore();

		}




		//call setup.
		this.init(id);

	};
	

//After load do all the cool stuff.
	document.addEventListener("DOMContentLoaded", function(){
		window.bD = new babyData("theChart");
		bD.updateChart([
			bD.dataset("steve",[1,2,3]),
			bD.dataset("phillip",[2,1,4])
			] ,{
				height:480,
				width:640,
				graph_type:"bar"
			});
	}, false);

	</script>
</head>
<body>
	<header id="baby-header">
		<h1>BabyName</h1>
		<nav id="action-bar">
			<button class="diaper">DIAPER </button>
			<button class="feeding">FEEDING</button>
			<button class="sleep">SLEEP</button>
		</nav>
	</header>
	
	<article>
		<nav class="tabs">
			<a href="#chart">glance</a>
			<a href="#timeline">Timeline</a>
			<a href="#chart">Chart</a>
		</nav>
		<div id="timeline">
			<h2> Event Timeline</h2>
			<p>details</p>
			<nav>
				<button>TODAY</button>
				<button>YESTERDAY</button>
				<button>WEEK</button>
				<button>MONTH</button>
				<button>ALL</button>
			</nav>
			
			<div id="events-list" >
				<div class="event diaper" id ="event-1234">
					<div class="chunk time">
						<span> + 2 HOUR</span>
					</div>
					<div class="chunk">
						<h3>DIAPER</h3>
						<p> Mixed</p>
					</div>
					<div class="chunk type">
						<p> User <a href="#">@Diaperbot</a></p>
						</div>
					<div class="chunk details">
						<p> auto filled</p>
					</div>
				</div>
				<div class="event feeding" id ="event-1234">
					<div class="chunk">
						<span> + 2 HOUR</span>
					</div>
					<div class="chunk">
						<h3>BOTTLE</h3>
						<p> :)</p>
					</div>
					<div class="chunk">
						<p> User <a href="#">@Diaperbot</a></p>
						</div>
					<div class="chunk">
						<p> Notes: auto filled</p>
					</div>
				</div>
				<div class="event sleep" id ="event-1234">
					<div class="chunk">
						<span> + 2 HOUR</span>
					</div>
					<div class="chunk">
						<h3>SLEEP</h3>
						<p> ENDED</p>
					</div>
					<div class="chunk">
						<p> User <a href="#">@Diaperbot</a></p>
					</div>
					<div class="chunk">
						<p> Notes: auto filled</p>
					</div>
				</div>
			</div>

		</div>
		<div id="chart">
			<h2>Chart</h2>
			<nav></nav>
			<canvas id="theChart" width="640" height="480"></canvas>
			<ul>
				<li>Test</li>
			</ul>
			<script>
			
			</script>
		</div>

		<div id="glance">
			<h2>At a Glance</h2>
			<div id="events-list" >
					<div class="event diaper" id ="event-1234">
						<div class="chunk time">
							<span> + 2 HOUR</span>
						</div>
						<div class="chunk">
							<h3>DIAPER</h3>
							<p> Mixed</p>
						</div>
						<div class="chunk type">
							<p> User <a href="#">@Diaperbot</a></p>
							</div>
						<div class="chunk details">
							<p> auto filled</p>
						</div>
					</div>
					<div class="event feeding" id ="event-1234">
						<div class="chunk">
							<span> + 2 HOUR</span>
						</div>
						<div class="chunk">
							<h3>BOTTLE</h3>
							<p> :)</p>
						</div>
						<div class="chunk">
							<p> User <a href="#">@Diaperbot</a></p>
							</div>
						<div class="chunk">
							<p> Notes: auto filled</p>
						</div>
					</div>
					<div class="event sleep" id ="event-1234">
						<div class="chunk">
							<span> + 2 HOUR</span>
						</div>
						<div class="chunk">
							<h3>SLEEP</h3>
							<p> ENDED</p>
						</div>
						<div class="chunk">
							<p> User <a href="#">@Diaperbot</a></p>
						</div>
						<div class="chunk">
							<p> Notes: auto filled</p>
						</div>
					</div>
			</div>
		</div>
	</article>
	<footer>
	this is wasted space.
	</footer>
</body>
</html>
